#!/bin/bash

# RuleWeaver Build Script
# Builds the production distribution with timestamp-based versioning

set -e

echo "ğŸ”¨ Building RuleWeaver..."
echo ""

# Generate timestamp version (0.YYMMDD.HHMM format for semver compatibility)
VERSION="0.$(date +"%y%m%d.%H%M")"
echo "ğŸ“… Setting version to: $VERSION"
echo ""

# Update package.json version
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS sed
    sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json
else
    # Linux sed
    sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json
fi
echo "âœ“ Updated package.json"

# Update Cargo.toml version
if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
else
    sed -i "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
fi
echo "âœ“ Updated Cargo.toml"

# Update tauri.conf.json version
if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
else
    sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
fi
echo "âœ“ Updated tauri.conf.json"

# Create/update version.json for frontend access
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
echo "{ \"version\": \"$VERSION\", \"timestamp\": \"$TIMESTAMP\" }" > public/version.json
echo "âœ“ Updated public/version.json"

echo ""

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing dependencies..."
    npm install
    echo ""
fi

# Run linting
echo "ğŸ” Running linters..."
npm run lint
npm run lint:rust
echo ""

# Run type checks
echo "ğŸ“‹ Running type checks..."
npm run typecheck
echo ""

# Run tests
echo "ğŸ§ª Running tests..."
npm run test
npm run test:rust
echo ""

# Build the application
echo "ğŸ—ï¸  Building production bundle..."
npm run tauri:build

echo ""
echo "âœ… Build complete! Version: $VERSION"
echo "ğŸ“ Distribution files are in src-tauri/target/release/bundle/"
